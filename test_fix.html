<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试修复的状态栏功能</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f8f8;
            --text-primary: #000000;
            --border-color: #d0d0d0;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 14px;
            line-height: 1.4;
        }

        .status-bar {
            height: 45px;
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            font-size: 12px;
            color: var(--text-primary);
            flex-shrink: 0;
            cursor: pointer;
        }

        .status-left {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .status-item {
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            padding: 2px 6px;
            border-radius: 3px;
            background: var(--bg-primary);
        }

        .preferences-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .preferences-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="status-bar" id="statusBar">
        <div class="status-left">
            <span id="charCount" class="status-item">0 字</span>
            <span id="wordCount" class="status-item">0 词</span>
            <span id="lineCount" class="status-item">0 行</span>
            <span id="selectedCount" class="status-item">已选 0 字符</span>
            <span id="colCount" class="status-item">1|1</span> 
            <span id="positionPercent" class="status-item">0%</span>
        </div>
        <div class="status-right">
            <span id="dateTimeDisplay" class="status-item">--/-- --:--</span>
        </div>
    </div>

    <button class="preferences-btn" id="preferencesBtn">打开偏好设置</button>

    <div class="preferences-panel" id="preferencesPanel" style="display: none;">
        <h3>显示设置</h3>
        <div class="checkbox-group">
            <input type="checkbox" id="showLineCount" checked>
            <label for="showLineCount">总行数</label>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="showCharCount" checked>
            <label for="showCharCount">字符数</label>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="showWordCount" checked>
            <label for="showWordCount">词数统计</label>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="showColCount" checked>
            <label for="showColCount">光标位置</label>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="showSelectedCount" checked>
            <label for="showSelectedCount">选中字符</label>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="showPositionPercent" checked>
            <label for="showPositionPercent">位置百分比</label>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="showDateTime" checked>
            <label for="showDateTime">显示时间日期</label>
        </div>
    </div>

    <script>
        // 模拟修复后的功能
        class StatusBarManager {
            constructor() {
                this.statusBar = document.getElementById('statusBar');
                this.statusItems = [
                    'charCount', 'wordCount', 'lineCount', 'selectedCount',
                    'colCount', 'positionPercent', 'dateTimeDisplay'
                ];
                
                // 获取所有偏好设置复选框
                this.showLineCount = document.getElementById('showLineCount');
                this.showCharCount = document.getElementById('showCharCount');
                this.showWordCount = document.getElementById('showWordCount');
                this.showColCount = document.getElementById('showColCount');
                this.showSelectedCount = document.getElementById('showSelectedCount');
                this.showPositionPercent = document.getElementById('showPositionPercent');
                this.showDateTime = document.getElementById('showDateTime');
                
                this.preferencesPanel = document.getElementById('preferencesPanel');
                this.preferencesBtn = document.getElementById('preferencesBtn');
                
                this.initEventListeners();
                this.restoreStatusBarVisibility();
            }
            
            initEventListeners() {
                // 状态栏双击切换显示/隐藏功能
                this.statusItems.forEach(itemId => {
                    const element = document.getElementById(itemId);
                    if (element) {
                        element.addEventListener('dblclick', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            this.hideStatusItem(element);
                        });

                        element.style.cursor = 'pointer';
                        element.title = element.title || '双击隐藏此项目';
                    }
                });
                
                // 偏好设置按钮事件
                this.preferencesBtn.addEventListener('click', () => {
                    this.preferencesPanel.style.display = this.preferencesPanel.style.display === 'none' ? 'block' : 'none';
                });
                
                // 偏好设置复选框变化事件
                const preferenceElements = [
                    this.showWordCount, this.showCharCount,
                    this.showLineCount, this.showColCount, this.showSelectedCount, this.showPositionPercent, this.showDateTime
                ];

                preferenceElements.forEach(element => {
                    element.addEventListener('change', () => {
                        console.log(`Preference changed: ${element.id}`);
                        this.saveAndApplyPreferences();
                    });
                });
            }
            
            // 状态栏项目隐藏功能（修复后）
            hideStatusItem(element) {
                if (!element) return;

                const currentState = element.style.display;
                const isVisible = currentState !== 'none' && currentState !== '';

                if (isVisible) {
                    // 隐藏元素
                    element.style.display = 'none';
                    // 保存到本地存储
                    const itemId = element.id;
                    if (itemId) {
                        localStorage.setItem(`status_${itemId}_visible`, 'false');
                    }

                    // 同步更新偏好设置中的对应复选框
                    this.syncPreferenceWithStatusItem(itemId, false);

                    // 提供视觉反馈
                    this.showTemporaryMessage(element, '已隐藏');
                }
            }
            
            // 显示临时消息
            showTemporaryMessage(element, message) {
                if (!element) return;

                const originalText = element.textContent;
                const originalTitle = element.title;

                // 临时显示消息
                element.textContent = message;
                element.style.backgroundColor = '#0078d4';
                element.style.color = 'white';
                element.style.fontWeight = 'bold';

                // 500ms后恢复
                setTimeout(() => {
                    element.textContent = originalText;
                    element.style.backgroundColor = '';
                    element.style.color = '';
                    element.style.fontWeight = '';
                    element.title = originalTitle;
                }, 500);
            }
            
            // 同步状态栏项目与偏好设置
            syncPreferenceWithStatusItem(itemId, isVisible) {
                // 根据itemId映射到对应的偏好设置项
                const preferenceMap = {
                    'charCount': 'showCharCount',
                    'wordCount': 'showWordCount', 
                    'lineCount': 'showLineCount',
                    'selectedCount': 'showSelectedCount',
                    'colCount': 'showColCount',
                    'positionPercent': 'showPositionPercent',
                    'dateTimeDisplay': 'showDateTime'
                };

                const preferenceKey = preferenceMap[itemId];
                if (preferenceKey) {
                    // 更新偏好设置复选框的状态
                    const checkbox = document.getElementById(preferenceKey);
                    if (checkbox) {
                        checkbox.checked = isVisible;
                    }
                }
            }
            
            // 保存并应用偏好设置
            saveAndApplyPreferences() {
                const preferences = {
                    showWordCount: this.showWordCount.checked,
                    showCharCount: this.showCharCount.checked,
                    showLineCount: this.showLineCount.checked,
                    showColCount: this.showColCount.checked,
                    showSelectedCount: this.showSelectedCount.checked,
                    showPositionPercent: this.showPositionPercent.checked,
                    showDateTime: this.showDateTime.checked
                };

                localStorage.setItem('notepad-preferences', JSON.stringify(preferences));
                this.applyPreferences(preferences);
            }
            
            // 应用偏好设置
            applyPreferences(preferences) {
                // 更新本地存储的状态栏项目可见性设置
                this.updateStatusBarVisibilityInStorage(preferences);
                
                // 应用到UI元素
                const applyElementVisibility = (elementId, preferenceValue) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        if (preferenceValue === false) {
                            element.style.display = 'none';
                        } else {
                            element.style.display = 'inline-block';
                        }
                    }
                };

                applyElementVisibility('charCount', preferences.showCharCount);
                applyElementVisibility('wordCount', preferences.showWordCount);
                applyElementVisibility('lineCount', preferences.showLineCount);
                applyElementVisibility('selectedCount', preferences.showSelectedCount);
                applyElementVisibility('colCount', preferences.showColCount);
                applyElementVisibility('positionPercent', preferences.showPositionPercent);
                applyElementVisibility('dateTimeDisplay', preferences.showDateTime);
            }
            
            // 更新本地存储的状态栏项目可见性设置
            updateStatusBarVisibilityInStorage(preferences) {
                const statusItems = [
                    { id: 'charCount', visible: preferences.showCharCount !== false },
                    { id: 'wordCount', visible: preferences.showWordCount !== false },
                    { id: 'lineCount', visible: preferences.showLineCount !== false },
                    { id: 'selectedCount', visible: preferences.showSelectedCount !== false },
                    { id: 'colCount', visible: preferences.showColCount !== false },
                    { id: 'positionPercent', visible: preferences.showPositionPercent !== false },
                    { id: 'dateTimeDisplay', visible: preferences.showDateTime !== false }
                ];

                statusItems.forEach(item => {
                    localStorage.setItem(`status_${item.id}_visible`, item.visible);
                });
            }
            
            // 恢复状态栏项目可见性设置
            restoreStatusBarVisibility() {
                this.statusItems.forEach(itemId => {
                    const element = document.getElementById(itemId);
                    if (element) {
                        const savedState = localStorage.getItem(`status_${itemId}_visible`);
                        if (savedState === 'false') {
                            element.style.display = 'none';
                            // 同步更新偏好设置中的对应复选框
                            this.syncPreferenceWithStatusItem(itemId, false);
                        } else {
                            element.style.display = 'inline-block';
                            // 同步更新偏好设置中的对应复选框
                            this.syncPreferenceWithStatusItem(itemId, true);
                        }
                    }
                });
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            window.statusBarManager = new StatusBarManager();
        });
    </script>
</body>
</html>